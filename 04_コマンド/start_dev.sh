#!/bin/bash

# è‡ªå‹•æ·»å‰Šã‚·ã‚¹ãƒ†ãƒ  - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# ä½¿ç”¨æ–¹æ³•: ./start_dev.sh

cd "$(dirname "$0")/../web"

echo "=========================================="
echo "è‡ªå‹•æ·»å‰Šã‚·ã‚¹ãƒ†ãƒ  - é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™"
echo "=========================================="
echo ""

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèª
if [ ! -f .env.local ]; then
    echo "âš ï¸  è­¦å‘Š: .env.local ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "   ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ãã ã•ã„"
    echo ""
fi

# node_modulesã®ç¢ºèª
if [ ! -d "node_modules" ]; then
    echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã¾ã™..."
    npm install
    echo ""
fi

# ãƒãƒ¼ãƒˆ3000ãŒä½¿ç”¨ä¸­ã®å ´åˆã¯åœæ­¢
if lsof -ti:3000 > /dev/null 2>&1; then
    echo "âš ï¸  ãƒãƒ¼ãƒˆ3000ãŒä½¿ç”¨ä¸­ã§ã™ã€‚æ—¢å­˜ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’åœæ­¢ã—ã¾ã™..."
    lsof -ti:3000 | xargs kill -9 2>/dev/null || true
    sleep 2
fi

echo "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
echo "   ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã‚’é–‹ã„ã¦ãã ã•ã„"
echo ""

# ã‚µãƒ¼ãƒãƒ¼èµ·å‹•å¾Œã«ãƒ–ãƒ©ã‚¦ã‚¶ã‚’è‡ªå‹•ã§é–‹ã
npm run dev &
DEV_PID=$!

# ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹ã¾ã§å¾…æ©Ÿï¼ˆæœ€å¤§15ç§’ï¼‰
echo "â³ ã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•ã‚’å¾…æ©Ÿã—ã¦ã„ã¾ã™..."
for i in {1..15}; do
    if curl -s http://localhost:3000 > /dev/null 2>&1; then
        echo ""
        echo "âœ… ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã„ã¦ã„ã¾ã™..."
        sleep 1
        # macOSã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‹ã
        if [[ "$OSTYPE" == "darwin"* ]]; then
            open http://localhost:3000
        elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
            xdg-open http://localhost:3000
        elif [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "win32" ]]; then
            start http://localhost:3000
        fi
        break
    fi
    echo -n "."
    sleep 1
done
echo ""

# ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å®Ÿè¡Œã‚’ç¶™ç¶š
wait $DEV_PID

