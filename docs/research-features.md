# auto-tensaku-system 機能・エラー・制限事項 調査レポート

> 調査日: 2026-02-12
> 対象: `web/src/` 配下のソースコード全体

---

## 1. 画面ごとの機能一覧

### 1-1. トップページ (`web/src/app/page.tsx`)

メインの添削画面。約6,000行の大規模コンポーネント。

#### 基本操作フロー
1. **問題番号の選択** - 大問+小問 / 小問のみ / 自由入力の3形式
2. **ファイルアップロード** - ドラッグ&ドロップまたはファイル選択
3. **ファイルの役割指定** - アップロード後にポップアップで各ファイルの役割を選択
4. **OCR確認** - AI読み取り結果の確認・手動修正
5. **採点実行** - 確認後に採点開始
6. **採点結果の表示** - GradingReportコンポーネントで表示
7. **PDFレポート出力** - 印刷/PDF保存
8. **再採点** - 厳しさを変更して無料再採点（2回まで）

#### 問題番号の入力形式
| 形式 | 表記例 | 説明 |
|------|--------|------|
| 大問+小問 (`big-small`) | `大問1 問1`, `大問2 (1)` | 大問番号+小問番号の組み合わせ |
| 小問のみ (`small-only`) | `問1`, `(1)`, `(a)` | 小問番号のみ |
| 自由入力 (`free`) | 任意の文字列 | 自由記述 |

小問の表記バリエーション:
- `number`: 問1, 問2, ...
- `paren-number`: (1), (2), ...
- `paren-alpha`: (a), (b), ...
- `number-sub`: 問1-2, 問1-3, ...

#### 一括追加モード
- 開始番号から終了番号（デフォルト5）まで複数の問題を一括で追加可能

#### 採点の厳しさ（3段階）
| 値 | 表示名 | 説明 |
|----|--------|------|
| `lenient` | 甘め | 寛容な採点 |
| `standard` | 標準 | 標準的な採点（デフォルト） |
| `strict` | 厳しめ | 厳格な採点 |

#### モード切替
- **通常モード（single）**: 1人の答案を採点
- **一括処理モード（batch）**: 複数の生徒の答案を同時採点（最大10人）

#### 一括処理モードの機能
- 共通ファイル（問題・模範解答）+ 生徒ごとの答案ファイル
- 各生徒のOCR確認フロー
- 生徒ごとの採点結果表示
- 失敗した生徒の再試行
- ZIPダウンロード（全生徒の採点レポートをPDFでまとめ）
- 重複ファイル検出（同じファイルが複数生徒に割り当てられている場合に警告）

#### 模範解答入力
- **画像モード**: 画像/PDFファイルとしてアップロード
- **テキストモード**: テキスト入力で模範解答を直接記入

#### その他の機能
- **OCR手動修正モーダル**: AI読み取り結果を手動で修正してから再採点
- **問題条件オーバーライド**: AIが誤読した字数制限などを手動で指定
- **フィードバック編集**: 採点結果の「良かった点」「改善アドバイス」「書き直し例」を手動編集
- **生徒名・添削担当者名**: PDFレポートに記載
- **PDFページ番号指定**: 複数ページPDFの答案ページ・問題ページ・模範解答ページを個別指定
- **次の問題へ進む**: ファイルも含めて全リセット
- **同じファイルで別の設問**: ファイルは保持したまま問題選択のみリセット

---

### 1-2. 料金ページ (`web/src/app/pricing/page.tsx`)

#### 料金プラン（3プラン）
| プラン | 月額（税込） | 通常価格 | 採点回数 | 対象 |
|--------|-------------|---------|---------|------|
| ライト | 980円 | 1,480円 | 月10回 | 気軽に始めたい方 |
| スタンダード | 2,980円 | 3,980円 | 月30回 | 定期的に学習したい方（人気No.1） |
| 無制限 | 5,980円 | 9,800円 | 無制限 | 塾・講師向け（2デバイスでのみ使用可） |

全プランの共通機能:
- 詳細なフィードバック
- 書き直し例の提示
- 無制限プランのみ: メールサポート

#### 重要な注意事項（ページ内に表示）
- 採点回数は契約日から30日ごとにリセット（未使用分の繰り越しなし）
- 全プランで1アカウントあたり最大2台のデバイスで利用可能
- 無制限プランもリセット対象外（回数制限なし）

#### FAQ（ページ内）
1. プラン変更はいつでも可能（アップグレード即時、ダウングレード次回更新日から）
2. 解約はいつでも可能（契約期間終了まで利用可）
3. 回数使い切りで次のリセット日まで利用不可
4. 初回登録で3回分の無料採点
5. クレジットカード対応（Visa、Mastercard、Amex、JCB）、Stripe決済

#### Checkout状態表示
- **成功時**: 「お申し込みが完了しました！利用状況ページに移動します...」（3秒後リダイレクト）
- **キャンセル時**: 「決済がキャンセルされました。いつでも再度お申し込みいただけます。」（5秒後消去）
- **期間限定キャンペーン**: バナー表示

---

### 1-3. 使い方ページ (`web/src/app/usage/page.tsx`)

ステップバイステップの使い方ガイド。

1. **問題番号を入力** - 大問+小問、小問のみ、自由入力の3形式
2. **ファイルをアップロード** - 画像（JPEG、PNG、GIF、WebP、HEIC）、PDF対応
3. **ファイルの役割を指定** - 答案、問題、模範解答、問題+模範解答
4. **採点を実行** - 結果に得点、フィードバック、減点ポイント、書き直し例が含まれる

便利な機能の説明:
- 再採点機能（初回後2回まで無料）
- PDFレポート出力
- OCR結果の確認・修正
- 採点の厳しさ調整

ファイルサイズに関する注意: 「1ファイルあたり4MB以下、合計4MB以下」

---

### 1-4. アカウント管理 (`web/src/app/account/page.tsx`)

- メールアドレスの表示
- ユーザーIDの表示
- 登録日の表示
- ログインが必要（未ログイン時は「ログインが必要です」表示）

---

### 1-5. サブスクリプション管理 (`web/src/app/subscription/page.tsx`)

- 現在のプラン表示（プラン名、ステータス）
- 利用状況（使用回数/上限、残り回数）
- 無料体験中の表示（体験期間残り日数、使用回数）
- Stripeカスタマーポータルへのリンク（プラン変更・解約・支払い方法変更）
- 未ログイン時は自動リダイレクト

---

### 1-6. プライバシーポリシー (`web/src/app/privacy/page.tsx`)

タイトル: 「本アプリケーションについて」
内容: プライバシーポリシー、デバイス制限、その他の重要な情報
最終更新日: 2025年11月25日

セクション:
1. 基本方針
2. 収集する情報
3. データの利用目的
4. データの保管
5. ユーザーの権利
6. お問い合わせ

---

## 2. 対応ファイル形式と制限

### 2-1. 対応ファイル形式

| 形式 | MIMEタイプ | 拡張子 |
|------|-----------|--------|
| JPEG | image/jpeg | .jpg, .jpeg |
| PNG | image/png | .png |
| GIF | image/gif | .gif |
| WebP | image/webp | .webp |
| BMP | - | .bmp |
| HEIC/HEIF | image/heic, image/heif | .heic, .heif |
| PDF | application/pdf | .pdf |

### 2-2. ファイルサイズ制限

| 項目 | 制限値 | 定義箇所 |
|------|--------|----------|
| 単一ファイル最大サイズ（クライアント） | 50MB | `page.tsx` MAX_FILE_SIZE |
| 単一ファイル最大サイズ（サーバー検証） | 4.3MB | `route.ts` MAX_SINGLE_FILE_SIZE |
| 合計ファイルサイズ（サーバー検証） | 4.3MB | `route.ts` MAX_TOTAL_SIZE |
| 合計ファイルサイズ（クライアント圧縮後チェック） | 4.2MB | `page.tsx` MAX_TOTAL_SIZE_BYTES |
| 最大ファイル数 | 10個 | `page.tsx` MAX_FILES / `route.ts` MAX_FILES_COUNT |
| ファイル名最大長 | 255文字 | `route.ts` validateFile |

### 2-3. 画像圧縮処理

クライアント側で自動圧縮が行われる:

| 設定 | 最大サイズ | 最大解像度 (モバイル/PC) | 品質 |
|------|-----------|------------------------|------|
| デフォルト（1-2枚） | 0.6MB | 1600px / 2048px | 0.8 |
| 低品質（3-4枚） | 0.25MB | 1200px / 1400px | 0.6 |
| 超低品質（5枚以上） | 0.15MB | 1000px | 0.4 |

- HEIC形式は自動的にJPEGに変換
- 圧縮タイムアウト: 1ファイルあたり最大4秒、全体で最大30秒
- 圧縮失敗時は元ファイルで続行

### 2-4. PDF処理
- 複数ページPDFに対応
- ページ番号指定で特定ページのみ抽出可能（答案ページ、問題ページ、模範解答ページを別々に指定）
- PDFはGemini APIに直接送信

### 2-5. 一括処理モードの制限

| 項目 | 制限値 |
|------|--------|
| 最大生徒数 | 10人 |
| 1生徒あたりの最大ファイル数 | 5個 |
| 1生徒あたりの最小ファイル数 | 2個 |

---

## 3. エラーメッセージ一覧

### 3-1. ファイルアップロード関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `一度にアップロードできるファイルは10個までです。` | ファイル数が10を超えた場合 |
| `画像ファイル（JPG、PNG、HEIC等）またはPDFファイルのみアップロードできます。（最大50MB）` | 有効なファイルが0個の場合 |
| `ファイルの合計サイズが大きすぎます（{X}MB、{N}枚）。合計{Y}MB以下になるように、ファイルを分割するか、写真の枚数を減らしてください。` | 圧縮後の合計サイズ超過 |
| `ファイルの合計サイズが大きすぎます（{X}MB）。合計{Y}MB以下になるように、ファイルを分割してください。` | 合計サイズ超過（PDF含む場合はPDF圧縮アドバイス付加） |
| `ファイル「{filename}」が大きすぎます（{X}MB）。4.3MB以下のファイルをアップロードしてください。` | 単一ファイルサイズ超過 |
| `PDFはページ番号を指定すると必要ページだけ抽出して軽くできます。難しい場合はオンライン圧縮ツール（iLovePDF等）で圧縮してから再度お試しください。` | PDF関連のサイズ超過時に追加表示 |

### 3-2. 認証関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `ログインが必要です。アカウントにログインしてください。` | API呼び出し時に未認証 |
| `セッションが切れました。再度ログインしてください。` | 採点時/再採点時にセッション期限切れ |
| `ログインリンクをメールで送信しました。メールをご確認ください。` | マジックリンク送信成功 |
| `確認メールを送信しました。メールをご確認ください。` | 新規登録成功 |
| `パスワードリセットリンクをメールで送信しました。メールをご確認ください。` | パスワードリセット成功 |
| `エラーが発生しました` | 認証処理中の一般エラー |

### 3-3. 採点関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `ファイルをアップロードしてください。` | ファイル未選択で採点開始 |
| `ファイルをアップロードしてください。本人の答案、問題がすべてクリアに写っていることを確認してください。` | ファイル未選択（API側検証） |
| `採点対象の問題を選択または入力してください。` | 問題番号未入力 |
| `採点する問題を選択してください` | 一括処理で問題未選択 |
| `採点処理がタイムアウトしました（5分経過）。画像ファイルのサイズが大きい場合、圧縮してから再度お試しください。` | 5分タイムアウト |
| `採点処理がタイムアウトしました（5分経過）。` | 手動再採点時の5分タイムアウト |
| `採点処理中にエラーが発生しました。ネットワーク接続を確認し、再度お試しください。` | ネットワークエラー等 |
| `採点処理中にエラーが発生しました。` | 手動再採点中のエラー |
| `通信エラーが発生しました。` | fetch例外（一般） |
| `再採点中にエラーが発生しました。` | 再採点中のエラー |
| `採点に失敗しました` | バッチ採点の個別失敗 |
| `レスポンスの形式が不正です` | API応答が不正な形式 |
| `通信エラー` | バッチ採点中のfetch例外 |
| `サーバーエラー: {response text}` | JSONパース失敗 |
| `ZIPファイルの生成に失敗しました` | ZIP生成エラー |
| `採点結果が不完全: {missing fields}` | AI応答に必要フィールドが不足 |

### 3-4. OCR関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `OCR処理中にエラーが発生しました` | OCR処理中の一般エラー |
| `OCR処理中にエラーが発生しました。` | OCRのfetch例外 |
| `OCR結果が取得できませんでした` | OCRレスポンスにocrResultがない |
| `ファイルの合計サイズが大きすぎます。ファイルを圧縮するか、分割してください。` | 413レスポンス |
| `OCRサーバーがタイムアウトしました。時間をおいて再試行してください。` | 504レスポンス |
| `OCRサーバーの応答が不正です（status {X}）。` | JSONパース失敗（非413/504） |
| `OCRリクエストが失敗しました（status {X}）。` | APIレスポンスが非200 |
| `読み取り結果がありません。` | confirmedTextsが空 |
| `ファイルがありません。` | uploadedFilesが空 |

### 3-5. プラン・利用制限関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `利用可能なプランがありません。プランを購入してください。` | canUse=false |
| `利用状況の確認中にエラーが発生しました。` | can_use_service RPC失敗 |
| `使用可能回数が不足しています（残り{X}回、必要{Y}回）` | 一括処理で回数不足 |
| `プランを購入してください` | サブスクリプションなしの表示（UsageStatus） |
| `無料体験終了 - プランを購入` | 無料体験終了時の表示（UsageStatus compact） |
| `無料体験が終了しました` | 無料体験終了時の表示（バナー） |
| `残り回数が少なくなっています。継続してご利用される場合は、プランの追加購入をご検討ください。` | 残り3回以下 |
| `無料再採点の回数が残っていません。` | 再採点トークンの残り0回 |

### 3-6. デバイス制限関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `デバイス上限に達しました` | モーダルタイトル |
| `最大{X}台のデバイスで利用可能です` | モーダルサブタイトル |
| `このアカウントは既に{X}台のデバイスで使用されています。新しいデバイスで使用するには、既存のデバイスを削除してください。` | モーダル説明文 |
| `デバイスの削除に失敗しました。` | デバイス削除失敗 |
| `エラーが発生しました。もう一度お試しください。` | デバイス処理中のエラー |
| `デバイス制限により利用できません。` | API側のデバイスアクセスチェック失敗 |
| `塾や学校で複数の教室でアカウントを共有することは利用規約で禁止されています。1アカウントは個人での利用を想定しています。` | デバイスモーダル内の注意書き |

### 3-7. レート制限関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `リクエストが多すぎます。{X}秒後に再試行してください。` | レートリミット超過（バースト: 10秒で2回、通常: 1分で5回） |
| `ただいま混雑しています。しばらく待ってから再度お試しください。` | 採点キューが満杯 |

### 3-8. ファイル検証関連（サーバー側）

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `許可されていないファイル形式です: {type}。画像（JPEG、PNG、GIF、WebP、HEIC）またはPDFをアップロードしてください。` | 不正なMIMEタイプ |
| `ファイル「{name}」が大きすぎます（{X}MB）。スマホで撮影した画像は自動圧縮されますが、圧縮に失敗した可能性があります。` | サーバー側サイズ検証（画像） |
| `ファイル「{name}」が大きすぎます（{X}MB）。PDFは容量オーバーしやすいため、スマホ等で写真を撮ってアップロードすることをおすすめします。` | サーバー側サイズ検証（PDF） |
| `不正なファイル名です。` | パストラバーサル検出 |
| `ファイル名が長すぎます。255文字以下にしてください。` | ファイル名長すぎ |
| `アップロードできるファイルは最大10個までです。` | ファイル数超過（サーバー側） |
| `問題番号が長すぎます（50文字以下にしてください）` | ラベル長超過 |
| `問題番号を入力してください` | 空のラベル |
| `問題番号に使用できない文字が含まれています` | 不正文字検出 |
| `HEIC画像「{name}」の変換に失敗しました。iPhoneのカメラ設定で「互換性優先」を選択するか、写真アプリでJPEG形式に変換してから再度アップロードしてください。` | サーバー側HEIC変換失敗 |

### 3-9. Stripe関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `決済セッションの作成に失敗しました` | Stripe Checkout作成失敗 |
| `決済処理中にエラーが発生しました` | Checkout処理中の一般エラー |
| `ポータルの起動に失敗しました` | Stripe Customer Portal作成失敗 |
| `お申し込みが完了しました！利用状況ページに移動します...` | Checkout成功 |
| `決済がキャンセルされました。いつでも再度お申し込みいただけます。` | Checkoutキャンセル |

### 3-10. システムエラー

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `システムエラーが発生しました。しばらく時間をおいてから再度お試しください。` | 本番環境での未処理エラー |
| `プラン情報を読み込み中...` | プランデータ未取得時 |
| `読み込み中...` | 認証ローディング中 |

### 3-11. 保存済み問題関連

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `問題が見つかりませんでした` | 保存済み問題の読み込み失敗 |
| `問題の読み込みに失敗しました` | 保存処理中の例外 |

### 3-12. 一括処理バリデーション

| エラーメッセージ | 発生条件 |
|----------------|----------|
| `共通ファイル（問題または模範解答）をアップロードしてください` | 共通ファイルなし |
| `すべての生徒に名前を入力してください` | 生徒名未入力 |
| `{生徒名}の答案をアップロードしてください` | 生徒の答案ファイルなし |

---

## 4. 料金プランと制限の詳細

### 4-1. 無料体験

| 項目 | 値 |
|------|-----|
| 無料体験回数 | 3回（`systemSettings.freeTrialUsageLimit`、デフォルト3） |
| 無料体験期間 | 7日（`systemSettings.freeTrialDays`、デフォルト7） |
| 体験終了条件 | 回数使い切り **または** 期間終了 |

### 4-2. 月額プラン詳細

Stripe連携（月額サブスクリプション）:
| プラン | Stripe Price ID環境変数 | 採点回数 |
|--------|------------------------|---------|
| ライト | `STRIPE_PRICE_LIGHT_ID` | 月10回 |
| スタンダード | `STRIPE_PRICE_STANDARD_ID` | 月30回 |
| 無制限 | `STRIPE_PRICE_UNLIMITED_ID` | 無制限 |

回数リセット: 契約日から30日ごと（サーバー側で管理）

### 4-3. デバイス制限

| 項目 | 値 |
|------|-----|
| 最大デバイス数 | 2台（全プラン共通） |
| デバイス識別 | ブラウザフィンガープリント |
| 制限超過時の動作 | DeviceLimitModal表示、既存デバイスの削除が必要 |

### 4-4. レート制限

| 制限 | 最大リクエスト | 時間枠 |
|------|--------------|--------|
| バースト抑止 | 2回 | 10秒 |
| 通常制限 | 5回 | 1分 |
| 認証制限 | 5回 | 5分 |

### 4-5. 再採点（無料）

| 項目 | 値 |
|------|-----|
| 無料再採点回数 | 2回（初回採点後） |
| トークン有効期限 | 7日 |
| 条件 | 同一ユーザー、同一ラベル、同一デバイスフィンガープリント |

### 4-6. サーバー制限

| 項目 | 値 |
|------|-----|
| APIタイムアウト | 300秒（Vercel Pro + Fluid Compute） |
| クライアントタイムアウト | 5分（fetch AbortController） |
| 推奨画像枚数上限 | 5枚（6枚以上でOCR精度低下の警告） |

---

## 5. 認証フロー

### 5-1. 認証モード

| モード | 説明 |
|--------|------|
| `signin` | メール+パスワードでログイン |
| `signup` | メール+パスワードで新規登録（確認メール送信） |
| `magic` | マジックリンク（パスワードなしでメールリンクログイン） |
| `reset` | パスワードリセット（リセットリンクをメール送信） |

### 5-2. 認証フロー
1. ユーザーがログイン/登録フォームを送信
2. Supabase Authで認証処理
3. 成功時: AuthProviderが自動的にセッション管理
4. ログイン成功時: モーダル自動クローズ（500ms待機）
5. パスワードリセット成功: 3秒後にログインモードに自動遷移

### 5-3. セッション管理
- Supabase SSRによるCookieベースセッション
- セッション切れ時はエラークリアして再ログイン促進
- APIリクエスト時にサーバー側でも認証チェック

---

## 6. 採点結果の表示内容（GradingReport）

### 6-1. 共通項目
- **ブランド表示**: EduShiftロゴ + サービス名
- **問題番号ラベル**: 大きく目立つ表示
- **ヘッダー**: 「採点レポート」タイトル、生徒名、実施日、添削担当者名
- **総合スコア**: 100%満点のパーセンテージ表示
- **得点表示**: 配点指定時は「X / Y 点」表示
- **良かった点**: 緑色のカード
- **改善のアドバイス**: 紫色のカード
- **AI読み取り結果（確認用）**: 青色のカード、モノスペースフォント
  - 注釈: 「※文字数判定の基準となります。誤読がある場合は撮影し直してください。」
- **減点ポイント**: テーブル形式（理由 + 減点幅%）
- **満点の書き直し例**: 黄色のカード、明朝体

### 6-2. 作文・自由記述の追加項目（problem_type === 'essay'）
観点別評価テーブル（各20点満点、A-E評価）:
1. テーマ・設問への応答
2. 構成・論理展開
3. 根拠・具体例
4. 考えの深さ・多角的視点
5. 表現・言語運用

加点要素: `bonus_points`（理由 + 加点%）

### 6-3. スコア正規化
- score <= 10 の場合: 10倍して0-100%に変換
- score > 10 の場合: そのまま使用（最大100）

---

## 7. 問題保存機能（SavedProblems）

### 7-1. 保存データ
IndexedDB（ブラウザローカル）に保存:
- 問題タイトル
- 選択された問題ラベル一覧
- 各問題の配点
- 問題形式・小問形式
- ファイルデータ（Blob）
- ファイルの役割（problem, model, problem_model のみ）
- 模範解答テキスト（テキストモードの場合）

### 7-2. 機能
- **保存**: 現在の問題設定+共通ファイルを保存
- **読み込み**: 保存済み問題を選択して復元
- **削除**: 保存済み問題を削除
- **一覧表示**: タイトル、問題数、ファイル数、合計サイズを表示

### 7-3. 制限
- ブラウザのIndexedDBに保存されるため、ブラウザデータ削除で消失
- デバイス間の同期なし
- 保存可能なファイルは問題・模範解答のみ（答案は保存対象外）

---

## 8. よくあるトラブルの種（コードから推測）

### 8-1. ファイルサイズ関連
- **Vercelのペイロード制限（4.5MB）**: 圧縮後も4.3MBを超えるとサーバー側で拒否される。特にPDFは圧縮されないため注意が必要。
- **画像圧縮タイムアウト**: モバイルでは高解像度画像の圧縮に時間がかかり、タイムアウト（全体30秒）する可能性がある。
- **HEIC変換失敗**: iPhoneのHEIC形式はクライアント/サーバー両方で変換を試みるが、どちらも失敗する場合がある。

### 8-2. OCR精度
- **画像枚数が多い場合**: 6枚以上でOCR精度低下の警告が出る。
- **手書き文字の認識**: 圧縮で解像度を下げすぎると手書き文字のOCRが失敗するリスク（コメントに明記あり）。
- **AI誤読**: OCR結果の確認画面で手動修正が可能だが、問題条件（字数制限など）の誤読は別途オーバーライドが必要。

### 8-3. セッション・認証
- **セッション期限切れ**: 長時間放置後に採点ボタンを押すとセッション切れが発生。
- **デバイス制限**: 2台を超えるデバイスからのアクセスでDeviceLimitModalが表示される。新しいデバイスで使うには既存デバイスの削除が必要。

### 8-4. 決済関連
- **Stripe Checkout途中離脱**: キャンセルメッセージが表示されるが、ブラウザバック等の場合はステータスが更新されない可能性。
- **Webhook遅延**: Stripeの決済完了通知（Webhook）が遅延した場合、購入直後に利用できない可能性がある。

### 8-5. レート制限
- **連打**: 10秒以内に3回以上のリクエストでバースト制限に引っかかる。
- **キュー満杯**: 同時リクエストが多い場合、「混雑しています」エラーが表示される。

### 8-6. 一括処理モード
- **使用回数の一括消費**: N人分の採点で回数をN回消費。確認ダイアログあり。
- **部分的な失敗**: 一部の生徒だけ失敗した場合、「失敗した生徒を再試行」機能で対応可能。
- **重複ファイル警告**: 同じファイルが複数生徒に割り当てられている場合に確認ダイアログが表示される。

### 8-7. ブラウザ互換性
- **iOS Safari**: `createImageBitmap` がハングする問題があり、モバイルでは無効化されている。
- **印刷機能**: `window.print()` がスマホでは非同期のため、close()を呼ばず手動で閉じる案内がある。

### 8-8. 保存済み問題
- **IndexedDB容量制限**: ブラウザのストレージ上限に達すると保存に失敗する。
- **データ消失リスク**: ブラウザのデータクリアで保存済み問題が消える。

---

## 9. AIモデル設定

| 設定 | デフォルト値 | 説明 |
|------|------------|------|
| MODEL_NAME | `gemini-3-pro-preview` | メイン採点モデル |
| OCR_MODEL_NAME | 空（MODEL_NAME使用） | OCR専用モデル |
| OCR_FALLBACK_MODEL_NAME | 空（無効） | OCR失敗時フォールバック |
| RATE_LIMIT_FALLBACK_MODEL | `gemini-2.5-pro-preview-05-06` | レート制限時の代替モデル |

---

## 10. コンポーネント一覧

| コンポーネント | ファイル | 役割 |
|--------------|---------|------|
| AuthModal | `components/AuthModal.tsx` | ログイン/登録/パスワードリセット/マジックリンク |
| AuthProvider | `components/AuthProvider.tsx` | 認証状態管理、プラン・使用量情報 |
| BatchProgress | `components/BatchProgress.tsx` | 一括処理の進捗表示 |
| BatchResults | `components/BatchResults.tsx` | 一括処理の結果表示 |
| DeviceLimitModal | `components/DeviceLimitModal.tsx` | デバイス上限到達時のモーダル |
| FreeAccessBanner | `components/FreeAccessBanner.tsx` | 無料体験/プロモ/体験終了のバナー |
| GradingReport | `components/GradingReport.tsx` | 採点結果レポート表示 |
| PricingPlans | `components/PricingPlans.tsx` | 料金プラン表示 |
| SavedProblems | `components/SavedProblems/` | 問題保存・読み込みUI |
| StudentCard | `components/StudentCard.tsx` | 一括処理の生徒カード |
| TrialEndedModal | `components/TrialEndedModal.tsx` | 無料体験終了モーダル |
| UsageStatus | `components/UsageStatus.tsx` | 利用状況表示 |
| UserMenu | `components/UserMenu.tsx` | ユーザーメニュー |
