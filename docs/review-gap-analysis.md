# 既存ドキュメント vs コードベース 差分分析レポート

> 調査日: 2026-02-12
> 対象ドキュメント: `docs/FAQ.md`, `docs/USER_GUIDE.md`, `docs/ADMIN_QUICK_REFERENCE.md`
> 比較元: `web/src/` 配下のソースコード（`research-features.md` の調査結果含む）

---

## 1. FAQ.md の正確性チェック

### 1-1. 無料体験の回数・期間

| 項目 | FAQ記載 | コードの実装 | 一致 |
|------|---------|-------------|------|
| 体験期間 | **7日間** | `freeTrialDays` デフォルト **7** (`AuthProvider.tsx:118`, `admin/page.tsx:47`) | **一致** |
| 採点回数 | **5回** | `freeTrialUsageLimit` デフォルト **3** (`AuthProvider.tsx:119`, `admin/page.tsx:48`) | **不一致** |
| 自動課金 | なし | Stripe連携だが自動課金ロジックなし | 一致 |

**重大な不一致**: FAQ Q15は「7日間・5回」と記載しているが、コードのデフォルト値は**3回**。pricing/page.tsxのFAQセクションでも「初回登録で3回分の無料採点」と記載。
- `TrialEndedModal.tsx:68`: `{systemSettings?.freeTrialUsageLimit || 3}回`
- `FreeAccessBanner.tsx:71`: `systemSettings?.freeTrialUsageLimit || 3`
- `UsageStatus.tsx:46`: `systemSettings?.freeTrialUsageLimit || 3`

> 注: admin画面で `free_trial_usage_limit` を変更可能だが、デフォルトは3。FAQの「5回」はどのコードにも存在しない。

---

### 1-2. ファイルサイズ上限

| 項目 | FAQ記載 | コードの実装 | 一致 |
|------|---------|-------------|------|
| ファイルサイズ上限 | **20MB** | クライアント: **50MB** (`page.tsx` MAX_FILE_SIZE)、サーバー: **4.3MB** (`route.ts` MAX_SINGLE_FILE_SIZE) | **不一致** |
| 推奨サイズ | 2MB以下 | 圧縮後ターゲット: 0.15MB〜0.6MB（ファイル数による） | おおむね一致 |

**重大な不一致**: FAQは「20MB」としているが、実際は:
- クライアント側バリデーション: 50MB（`page.tsx`のMAX_FILE_SIZE = 50 * 1024 * 1024）
- サーバー側バリデーション: 4.3MB（圧縮後の実効上限）
- 合計サイズ上限: 4.2MB（クライアント圧縮後）/ 4.3MB（サーバー）
- 「20MB」はコードに一切存在しない

FAQのエラー対策セクション（Q21）でも「20MB以下に圧縮」と記載しているが、実際は4.3MBが上限。

---

### 1-3. 対応ファイル形式

| 形式 | FAQ記載 | コードの実装 | 一致 |
|------|---------|-------------|------|
| JPEG (.jpg, .jpeg) | 記載あり | 対応 | 一致 |
| PNG (.png) | 記載あり | 対応 | 一致 |
| PDF (.pdf) | 記載あり | 対応 | 一致 |
| HEIC (.heic) | 記載あり | 対応（自動JPEG変換） | 一致 |
| **GIF (.gif)** | **記載なし** | **対応** (`page.tsx` VALID_EXTENSIONS) | **未記載** |
| **WebP (.webp)** | **記載なし** | **対応** (`page.tsx` VALID_EXTENSIONS) | **未記載** |
| **BMP (.bmp)** | **記載なし** | **対応** (`page.tsx` VALID_EXTENSIONS) | **未記載** |
| **HEIF (.heif)** | **記載なし** | **対応** (`page.tsx` VALID_EXTENSIONS) | **未記載** |

**不足**: GIF、WebP、BMP、HEIFがFAQに記載されていない。

---

### 1-4. デバイス制限

| 項目 | FAQ記載 | コードの実装 | 一致 |
|------|---------|-------------|------|
| 上限台数 | **2台** | `DeviceLimitModal.tsx` で `最大${maxDevices}台` | **一致** |
| デバイス管理場所 | 「アカウント」→「デバイス管理」 | DeviceLimitModalで削除可能、ただし「アカウント」→「デバイス管理」というUIは存在しない | **不一致** |

**軽微な不一致**: FAQ Q12には「アカウント」→「デバイス管理」と記載されているが、実際のコードではDeviceLimitModal（デバイス上限到達時のポップアップ）内でのみデバイス削除が可能。能動的にデバイスを管理する画面はコード上見当たらない。

---

### 1-5. 料金プラン

| 項目 | FAQ記載 | コードの実装 | 一致 |
|------|---------|-------------|------|
| ライト | ¥980/月 | ¥980/月（キャンペーン価格） | 一致 |
| スタンダード | ¥2,980/月 | ¥2,980/月（キャンペーン価格） | 一致 |
| 無制限 | ¥5,980/月 | ¥5,980/月（キャンペーン価格） | 一致 |

**注意**: FAQの価格はキャンペーン価格。コードには通常価格（ライト¥1,480、スタンダード¥3,980、無制限¥9,800）も存在し、取り消し線で表示される。FAQにはキャンペーンである旨の記載がない。

---

### 1-6. その他のFAQ不一致

| FAQ項目 | FAQ記載 | コードの実装 | 状態 |
|---------|---------|-------------|------|
| Q1: 対応問題 | 「作文・小論文（400字以上）」は対応が難しい | GradingReportに `essay` 問題タイプの観点別評価（5観点各20点）が実装されている | **不一致** |
| Q14: アカウント削除 | 「アカウントを削除する」ボタンの手順 | `account/page.tsx`にアカウント削除機能は見当たらない | **コードに存在しない可能性** |
| Q16: リセット日 | 「使用状況」ページで確認 | `subscription/page.tsx`に使用状況表示はあるが、次回リセット日の表示は明示されていない | **要確認** |
| Q28: 採点履歴 | 「履歴」ページで確認可能 | `grading_history`テーブルへの参照・UIは存在しない。履歴表示ページはコード内に未実装 | **コードに存在しない** |
| Q29: 団体利用 | ボリュームディスカウント、管理者機能 | 管理者向け機能はadmin/page.tsxがあるが、団体利用専用の機能は未実装 | **未実装** |
| Q26: スマホ対応 | 横向きにすると見やすい | モバイルファーストで設計されており、レスポンシブUI対応済み | 一致 |

---

## 2. USER_GUIDE.md の正確性チェック

### 2-1. バッチ処理の最大生徒数

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| 最大生徒数 | **5名** | **10名** (`batch.ts` MAX_STUDENTS = 10) | **不一致** |

**重大な不一致**: ガイドは「最大5名分」と記載しているが、コードの`MAX_STUDENTS`は**10**。

---

### 2-2. エクスポート機能

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| CSV形式エクスポート | **「CSV形式（Excel等で開けます）」** | **コードに存在しない** | **不一致** |
| PDF形式エクスポート | 「PDF形式（印刷用）」 | バッチ処理のZIPダウンロード（複数PDFをまとめて） + 個別の印刷/PDF保存機能 | **部分一致** |

**重大な不一致**: CSV形式のエクスポート機能はコードベースに一切存在しない。`export`、`csv`、`エクスポート`で検索しても該当なし。

PDF形式のエクスポートについては、バッチモードでのZIPダウンロード（`page.tsx`内でJSZipを使用して全生徒のPDFをまとめてダウンロード）と、個別採点結果の`window.print()`による印刷/PDF保存機能が存在する。ただし「エクスポート」というUI項目は存在しない。

---

### 2-3. 採点結果の表示項目

| ガイド記載 | コードの実装 | 一致 |
|-----------|-------------|------|
| 得点 | スコアパーセンテージ + 配点時の得点表示 | 一致 |
| 認識テキスト | AI読み取り結果表示 | 一致 |
| 良い点 | 緑色カードで表示 | 一致 |
| 改善アドバイス | 紫色カードで表示 | 一致 |
| 書き直し例 | 黄色カードで表示 | 一致 |
| 減点理由 | テーブル形式で表示 | 一致 |
| **作文・自由記述の観点別評価** | **ガイドに記載なし** | **未記載** |

**不足**: GradingReportには作文・自由記述（`essay`タイプ）の観点別評価（5観点各20点/A-E評価）が実装されているが、ガイドに記載がない。

---

### 2-4. 操作手順の正確性

| ガイド記載 | コードの実装 | 一致 |
|-----------|-------------|------|
| Step 1: ファイルの準備（2つのファイル） | 複数ファイル対応（最大10個）、role指定可能 | **不完全** |
| Step 2: 「生徒答案」と「模範解答」の2エリア | 単一のアップロードエリア + role指定ポップアップ | **不一致** |
| Step 3: 問題番号入力 | 3形式（大問+小問、小問のみ、自由入力）+ 一括追加モード | **不完全** |

**不一致**: ガイドでは「生徒答案をアップロード」と「解答・問題画像をアップロード」の2つのエリアが別々にあるように記載されているが、実際のUIは**単一のアップロードエリア**にファイルをアップロードし、その後**ポップアップで各ファイルの役割（answer, problem, model, problem_model等）を選択**する方式。

---

### 2-5. ファイルサイズ情報

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| ファイルサイズ上限 | **20MB/ファイル** | クライアント: 50MB、サーバー: 4.3MB | **不一致** |
| 推奨サイズ | 2MB以下 | 圧縮後ターゲット: 0.15MB〜0.6MB | おおむね一致 |

**FAQ.mdと同じ不一致**。

---

### 2-6. 無料トライアル情報

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| 期間 | **7日間** | デフォルト7日 | **一致** |
| 採点回数 | **5回** | デフォルト**3回** | **不一致** |

**FAQ.mdと同じ不一致**。

---

### 2-7. 対応ファイル形式

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| 記載形式 | JPEG, PNG, PDF, HEIC | JPEG, PNG, GIF, WebP, BMP, HEIC/HEIF, PDF | **不足** |

**FAQ.mdと同様**、GIF、WebP、BMP、HEIFが未記載。

---

## 3. 追加すべき機能の洗い出し（2025年1月以降の追加機能）

以下の機能はコードベースに実装されているが、FAQ.md・USER_GUIDE.mdに**記載がない**:

### 3-1. 問題保存機能（SavedProblems）

**コードの実装**: `web/src/components/SavedProblems/`, `web/src/lib/storage/`
- IndexedDB（ブラウザローカル）に問題設定・共通ファイルを保存
- タイトル付けて保存、一覧表示、読み込み、削除、上書き保存
- 保存対象: 問題ラベル、配点、形式、問題/模範解答ファイル、模範解答テキスト
- 答案ファイルは保存対象外

**ドキュメントへの影響**: FAQ・ガイドともに完全に未記載。繰り返し同じ問題セットで採点する塾講師にとって重要な機能。

---

### 3-2. 再採点機能（regradeToken）

**コードの実装**: `web/src/app/api/grade/route.ts`, `web/src/app/page.tsx`
- 初回採点後、同じ問題を**2回まで無料で再採点**可能（`REGRADE_MAX_FREE_TIMES_PER_LABEL = 2`）
- トークン有効期限: 7日間（`REGRADE_TOKEN_TTL_SECONDS = 7 * 24 * 60 * 60`）
- 採点の厳しさを変更して再採点できる
- 再採点は採点回数を消費しない
- 同一ユーザー、同一ラベル、同一デバイスフィンガープリントが条件

**ドキュメントへの影響**: FAQ Q17の「追加購入不可」の回答に再採点の存在を追記すべき。ガイドにも再採点手順の説明が必要。

---

### 3-3. 生徒カード機能（StudentCard）

**コードの実装**: `web/src/components/StudentCard.tsx`
- バッチ（一括採点）モードで各生徒の情報を表示するカードUI
- 生徒名、アップロードファイル数、OCRステータス、採点結果を表示
- ファイルのドラッグ&ドロップ受付
- 個別の再試行ボタン

**ドキュメントへの影響**: バッチ処理セクションの説明に生徒カードのUI説明を追加すべき。

---

### 3-4. カメラ撮影機能

**コードの実装**: `page.tsx:4261` - `capture="environment"`
- `<input type="file" accept="image/*,.pdf" capture="environment" />`
- スマートフォンでファイル選択時にカメラが直接起動する（HTML5標準機能）
- UIにはCameraアイコン（Lucide）がアップロードエリアに表示されている

**ドキュメントへの影響**: スマホでの撮影→即アップロードのフローをガイドに追記すべき。現在のガイドは「撮影→保存→アップロード」の前提で書かれている。

---

### 3-5. OCR確認・手動修正フロー

**コードの実装**: `page.tsx` OCRステップ管理
- OCRステップ: `idle` → `ocr-loading` → `confirm` → `grading`
- AI読み取り結果を表示し、ユーザーが確認してから採点に進む
- 手動修正モーダルでOCR結果を編集可能
- 問題条件（字数制限等）のオーバーライド機能

**ドキュメントへの影響**: ガイドのStep 5後にOCR確認ステップの説明が必要。現在のガイドは「採点する」ボタンを押して結果を待つだけの記載。

---

### 3-6. フィードバック編集機能

**コードの実装**: `page.tsx` Edit3アイコン関連
- 採点結果の「良かった点」「改善アドバイス」「書き直し例」を手動で編集可能
- 編集した内容はPDFレポートに反映される

**ドキュメントへの影響**: 塾講師がAIのフィードバックをカスタマイズできる点をガイドに追記すべき。

---

### 3-7. 模範解答テキスト入力モード

**コードの実装**: `page.tsx` modelAnswerTextMode関連
- 画像/PDFの代わりにテキストで模範解答を直接入力可能
- SavedProblemsにも`modelAnswerText`として保存される

**ドキュメントへの影響**: ガイドのStep 1で「模範解答はテキストでも入力可能」と追記すべき。

---

### 3-8. ZIPダウンロード（バッチモード）

**コードの実装**: `page.tsx` JSZip関連
- バッチ採点完了後、全生徒のPDFレポートをZIPファイルとしてまとめてダウンロード
- ファイル名に生徒名を含む

**ドキュメントへの影響**: ガイドのバッチ処理セクションに追記すべき（現在は「CSV形式」と「PDF形式」のエクスポートと記載されているが、実際はZIPダウンロード）。

---

### 3-9. 作文・自由記述の観点別評価

**コードの実装**: `GradingReport.tsx` essay_evaluation
- 問題タイプが`essay`の場合、5観点（テーマ・設問への応答、構成・論理展開、根拠・具体例、考えの深さ・多角的視点、表現・言語運用）で評価
- 各観点: A〜E評価 + 20点満点スコア + コメント
- 加点要素（bonus_points）の表示

**ドキュメントへの影響**: FAQ Q1では「作文・小論文は対応が難しい」とされているが、実際にはessay評価が実装されている。矛盾を解消すべき。

---

### 3-10. PDFページ番号指定

**コードの実装**: `page.tsx` pdfPageInfo
- 複数ページPDFの場合、答案ページ・問題ページ・模範解答ページを個別に指定可能
- 指定ページのみを抽出して送信（ファイルサイズ削減にも貢献）

**ドキュメントへの影響**: ガイドのPDF関連セクション（FAQ Q9）に追記すべき。

---

## 4. ADMIN_QUICK_REFERENCE.md の正確性チェック

### 4-1. 主な不一致

| 項目 | ガイド記載 | コードの実装 | 一致 |
|------|-----------|-------------|------|
| トライアル回数デフォルト | **5回** (`system_settings`テーブル) | **3回** (コードのフォールバック値) | **不一致** |
| 管理ダッシュボード | `/admin` パスで記載 | `web/src/app/admin/page.tsx` が存在 | 一致 |
| 環境変数 | 10個記載 | 基本一致（GEMINI_API_KEY等） | 一致 |
| system_settingsテーブル | `free_trial_usage_limit` デフォルト5 | コードのフォールバックは3 | **不一致** |

---

## 5. 差分サマリー（重要度順）

### 重大な不一致（即座に修正が必要）

| # | 項目 | ドキュメント | コード | 影響 |
|---|------|-------------|--------|------|
| 1 | **無料体験回数** | 5回（FAQ, ガイド, 管理者ガイド） | 3回（デフォルト） | ユーザーが期待より少ない回数で体験終了 |
| 2 | **ファイルサイズ上限** | 20MB（FAQ, ガイド） | 50MB（クライアント）/ 4.3MB（サーバー） | ユーザー混乱、エラー時に誤った対処法 |
| 3 | **バッチ最大生徒数** | 5名（ガイド） | 10名 | ユーザーが機能を過小評価 |
| 4 | **CSVエクスポート** | 記載あり（ガイド） | 未実装 | ユーザーが存在しない機能を探す |
| 5 | **作文対応** | 対応が難しい（FAQ） | essay評価が実装済み | ユーザーが使える機能を見逃す |

### 記載漏れ（追加が必要）

| # | 機能 | 説明 |
|---|------|------|
| 1 | **問題保存機能** | IndexedDBに問題設定を保存・読み込み |
| 2 | **再採点機能** | 同一問題を2回まで無料で再採点（厳しさ変更可） |
| 3 | **OCR確認フロー** | AIの読み取り結果を確認してから採点に進む |
| 4 | **フィードバック編集** | 採点結果のフィードバックを手動編集 |
| 5 | **模範解答テキスト入力** | 画像の代わりにテキストで模範解答を入力 |
| 6 | **カメラ直接撮影** | スマホでカメラ起動→即アップロード |
| 7 | **PDFページ指定** | 複数ページPDFの特定ページのみ使用 |
| 8 | **ZIPダウンロード** | バッチ採点結果の一括ダウンロード |
| 9 | **作文観点別評価** | 5観点のA-E評価と20点満点スコア |
| 10 | **生徒カードUI** | バッチモードの生徒別状態管理 |

### 軽微な不一致

| # | 項目 | 説明 |
|---|------|------|
| 1 | 対応ファイル形式 | GIF, WebP, BMP, HEIFが未記載 |
| 2 | デバイス管理画面 | FAQに「アカウント→デバイス管理」と記載あるが該当UIなし |
| 3 | 採点履歴ページ | FAQに「履歴」ページ記載あるが未実装 |
| 4 | アカウント削除 | FAQに手順記載あるがaccount/page.tsxに該当機能なし |
| 5 | アップロードUI | ガイドは2エリア方式だが実際は1エリア+role指定 |
| 6 | キャンペーン価格 | FAQの価格はキャンペーン価格だが明記なし |
| 7 | 対応問題のSTEP説明 | 一括追加モードの説明なし |

---

## 6. 修正推奨アクション

### 優先度: 高（事実と異なる情報）

1. **無料体験回数を「3回」に修正**（FAQ Q15, ガイド 5章, 管理者ガイド）
2. **ファイルサイズ上限の説明を修正**（FAQ Q8/Q21, ガイド 7章）
   - 提案: 「1ファイル50MBまでアップロード可能。アップロード時に自動圧縮され、合計4MB以下に調整されます」
3. **バッチ最大生徒数を「10名」に修正**（ガイド 4章）
4. **CSVエクスポートの記載を削除**、ZIPダウンロードに修正（ガイド 4章）
5. **作文対応の記載を修正**（FAQ Q1）

### 優先度: 中（機能の追記）

6. 問題保存機能のセクション追加（ガイド新章 or FAQ）
7. 再採点機能の説明追加（FAQ + ガイド）
8. OCR確認フローの説明追加（ガイド Step 5後）
9. カメラ撮影の使い方追加（ガイド 7章 or FAQ Q26）
10. 対応ファイル形式にGIF, WebP, BMP, HEIFを追加（FAQ Q7, ガイド 7章）

### 優先度: 低（存在しない機能の記載削除）

11. 採点履歴ページの記載を削除または「今後対応予定」に変更（FAQ Q28）
12. アカウント削除手順を実装に合わせて修正（FAQ Q14）
13. デバイス管理の導線説明を修正（FAQ Q12）
14. アップロードUIの説明を1エリア方式に修正（ガイド Step 2）
