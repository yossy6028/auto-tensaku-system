# Debug Log

デバッグの記録と再発防止策。

---

## [2026-02-19] OCR読み取りプレースホルダーが採点に伝播するバグ

### 問題
- OCR が手書き答案の読み取りに失敗した際、フォールバックテキスト「（回答を読み取れませんでした）」がそのまま採点APIに送信され、採点品質バリデーション（`validateGradingQuality`）でエラーになる
- ユーザーにはUI上で OCR 失敗が明示されず、プレースホルダーテキストが `confirmedTexts` にプリフィルされていた

### 原因
**根本原因**: OCR失敗を検出する正規表現が5箇所でバラバラに定義されており、検出基準が不統一だった

**5 Whys分析**:
1. なぜ採点エラーが出る？ → `validateGradingQuality` がプレースホルダーを検出
2. なぜプレースホルダーが採点に渡る？ → クライアントがOCR失敗テキストをそのまま送信
3. なぜクライアントがOCR失敗を検知しない？ → `!ocrResult?.text` (空チェック) しかしておらず、フォールバック文字列をチェックしていない
4. なぜフォールバック文字列が統一されていない？ → 各メソッドが独自の正規表現を持っていた
5. なぜ独自の正規表現に？ → 共通定数が定義されていなかった

### 解決手順
1. `grader.ts` に `OCR_PLACEHOLDER_PATTERN` 定数を追加（line 265）
2. 5箇所のローカル `placeholderPattern` を統一定数に置換
3. `grading/page.tsx` でOCR結果プリフィル時にプレースホルダー検出 → 空文字に
4. 採点送信前にバリデーション追加（全テキストが空/プレースホルダーの場合はブロック）
5. UI に「読み取りに失敗しました。手動で入力してください。」警告を追加

### 試行錯誤（効果なし）
- なし（コード分析で原因特定できた）

### 再発防止策
- [x] プレースホルダーパターンを `OCR_PLACEHOLDER_PATTERN` 定数に統一
- [ ] `performOcr` の戻り値に `success: boolean` フィールドを追加し、テキスト内容ではなく型レベルでOCR成功/失敗を区別する（将来改善）
- [ ] OCR失敗率が高い場合のメトリクス収集を検討

### 関連ファイル
- `web/src/lib/core/grader.ts` - OCR_PLACEHOLDER_PATTERN 定数 + 5箇所のパターン統一
- `web/src/app/(app)/grading/page.tsx` - クライアント側ガード追加
